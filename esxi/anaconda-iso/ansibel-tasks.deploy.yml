---


- name: install genisoimage
  become: true
  ansible.builtin.package:
    name: genisoimage
    state: present

- name: set anaconda_list
  ansible.builtin.set_fact:
    anaconda_list: []

- name: append anaconda_list
  loop: "{{ anaconda.all | dict2items | selectattr('key','in',anaconda.select) }}"
  loop_control:
    loop_var: kv
  vars:
    anaconda:
      name: "{{ kv.key }}"
    anaconda_item: "{{ kv.value | combine(anaconda, recursive=True) }}"
  ansible.builtin.set_fact:
    anaconda_list: "{{ anaconda_list + [anaconda_item] }}"

- debug: msg="{{ anaconda_list }}" verbosity=3

- name: create anaconda iso
  loop: "{{ anaconda_list }}"
  loop_control:
    loop_var: anaconda_item
  ansible.builtin.shell: 
    cmd: genisoimage -output {{ anaconda_item.output }} -volid OEMDRV -joliet -rock ks.cfg
    chdir: "{{ anaconda_item.path }}"

- name: set vm_copy_list
  ansible.builtin.set_fact:
    vm_copy_list: []

- name: append vm_copy_list
  loop: "{{ anaconda_list }}"
  loop_control:
    loop_var: anaconda_item
  when: anaconda_item.vsphere_copy is defined
  vars:
    vsphere_copy:
      hostname: "{{ esxi.server.hostname }}"
      username: "{{ vm_username | default(esxi.server.username,true) }}"
      password: "{{ vm_password | default(esxi.server.password,true) }}"
      validate_certs: false
      src: "{{ anaconda_item.path }}/{{ anaconda_item.output }}"
    vm_copy_item: "{{ anaconda_item.vsphere_copy | combine(vsphere_copy, recursive=True) }}"
  ansible.builtin.set_fact:
    vm_copy_list: "{{ vm_copy_list + [vm_copy_item] }}"

- debug: msg="{{ vm_copy_list }}" verbosity=3

- name: copy file to datastore
  loop: "{{ vm_copy_list }}"
  loop_control:
    loop_var: vm_copy_item
  community.vmware.vsphere_copy: "{{ vm_copy_item }}"
