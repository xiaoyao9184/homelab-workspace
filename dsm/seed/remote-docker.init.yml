---

- name: init
  vars:
    run_wsl: |
      ansible-playbook \
        --ask-become-pass \
        --inventory $PWD/ansible \
        $PWD/../../../dsm/seed/remote-docker.init.yml
    default:
      pip:
        - jsondiff
        - jmespath

        - pyyaml
        - lxml
        - requests

        - docker
        - docker-compose
  hosts: dsm
  tasks: 

    - name: install docker spk from server
      become: true
      ansible.builtin.shell: /usr/syno/bin/synopkg install_from_server Docker
      ignore_errors: true

    - name: set pip sources
      when: pip.mirror is defined
      ansible.builtin.shell: pip3 config set global.index-url {{ pip.mirror }}

    - name: update pip
      ansible.builtin.shell: python -m pip install -U pip
      register: pip_result
      until: "pip_result is not failed"
      retries: 3
      delay: 5

    - name: install pip package
      become: true
      loop: "{{ default.pip + (workspace.init.pip | default([]) | flatten) }}"
      ansible.builtin.pip:
        name: "{{ item }}"
        state: latest
      register: pip_result
      until: "pip_result is not failed"
      retries: 3
      delay: 5

    - name: add user to docker
      become: true
      ansible.builtin.shell: "synogroup --add root {{ ansible_user_id }}"
      # ansible.builtin.user:
      #   name: "{{ ansible_user_id }}"
      #   groups: docker
      #   append: true
