---

- name: init
  vars:
    run_wsl: |
      ansible-playbook \
        --ask-become-pass \
        --inventory $PWD/ansible \
        $PWD/../../../dsm/seed/remote-docker.init.yml
    default:
      pip:
        - jsondiff
        - jmespath

        - pyyaml
        - lxml
        - requests

        - docker
        - docker-compose
  hosts: dsm
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ env_path | default('',true) }}"
  tasks: 

    - name: install docker spk from server
      become: true
      ansible.builtin.shell: /usr/syno/bin/synopkg install_from_server Docker
      ignore_errors: true

    - name: set pip sources
      when: pip.mirror is defined
      become: true
      ansible.builtin.shell: pip3 config set global.index-url {{ pip.mirror }}

    - name: ensurepip pip
      ansible.builtin.shell: python3 -m ensurepip

    - name: install pip package
      become: true
      loop: "{{ default.pip + (remote.init.pip | default([]) | flatten) }}"
      ansible.builtin.pip:
        name: "{{ item }}"
        state: latest
      register: pip_result
      until: "pip_result is not failed"
      retries: 3
      delay: 5

    # cant add to root group for access docker
    # - name: add user to docker
    #   become: true
    #   ansible.builtin.shell: "synogroup --add root {{ ansible_user_id }}"
    # 
    # https://davejansen.com/manage-docker-without-needing-sudo-on-your-synology-nas/
    - name: stat docker api
      become: true
      ansible.builtin.stat:
        path: /var/run/docker.sock
      register: docker_stat

    - when: docker_stat.stat.gr_name != 'docker'
      block:
        
      - name: add docker group
        become: true
        ansible.builtin.shell: "synogroup --add docker"
        ignore_errors: true

      - name: add user to docker group
        become: true
        ansible.builtin.shell: "synogroup --member docker {{ ansible_user_id }}"

      - name: chown docker api
        become: true
        ansible.builtin.shell: "chown root:docker /var/run/docker.sock"
