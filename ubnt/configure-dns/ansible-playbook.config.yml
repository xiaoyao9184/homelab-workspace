---


- name: dep
  hosts: localhost
  connection: local
  tasks:

    - name: install ansible-pylibssh
      ansible.builtin.pip:
        name: ansible-pylibssh


- name: config
  vars:
    run_wsl: |
      ansible-playbook \
        --inventory $PWD/ansible \
        $PWD/../../../ubnt/configure-dns/ansible-playbook.config.yml
  hosts: ubnt
  tasks: 

    - name: load domain_csv
      community.general.read_csv:
        path: "{{ configure.dns.domain_csv }}"
      register: domain_csv
      delegate_to: localhost
      connection: local

    - name: delete dns
      community.network.edgeos_config:
        lines:
          - delete service dns forwarding options

    - name: configure dns by domain_csv
      when: 
        - item.cl_name != ''
        - item.where in location[location.at]
      community.network.edgeos_config:
        lines:
          - set service dns forwarding options address=/.{{ item.cl_name }}/{{ item.ip_addr }}
      loop: "{{ domain_csv.list }}"