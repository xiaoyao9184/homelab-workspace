---


- name: config
  vars:
    run_wsl: |
      ansible-playbook \
        --inventory $PWD/ansible \
        $PWD/../../../ubnt/configure-dhcp/ansible-playbook.config.yml
  hosts: ubnt
  tasks: 

    - name: load dhcp_csv
      community.general.read_csv:
        path: "{{ configure.dhcp.dhcp_csv }}"
      register: dhcp_csv
      delegate_to: localhost
      connection: local

    - name: delete dhcp
      community.network.edgeos_config:
        lines:
          - set service dhcp-server shared-network-name LAN subnet
      register: delete_result
      until: "delete_result is not failed"
      retries: 2
      delay: 1

    - name: configure dhcp
      when: 
        - item.cl_name != ''
        - item.location in location[location.at]
      community.network.edgeos_config:
        lines:
          - set service dhcp-server shared-network-name LAN subnet {{ subnet }} static-mapping {{ item.cl_name }}
          - set service dhcp-server shared-network-name LAN subnet {{ subnet }} static-mapping {{ item.cl_name }} ip-address {{ item.ip_addr }}
          - set service dhcp-server shared-network-name LAN subnet {{ subnet }} static-mapping {{ item.cl_name }} mac-address {{ item.mac }}
      loop: "{{ dhcp_csv.list }}"
      vars:
        subnet: 192.168.1.0/24
