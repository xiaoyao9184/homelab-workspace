---


- name: dep
  hosts: localhost
  connection: local
  tasks:

    - name: install ansible-pylibssh
      ansible.builtin.pip:
        name: ansible-pylibssh


- name: config
  vars:
    run_wsl: |
      ansible-playbook \
        --inventory $PWD/ansible \
        $PWD/../../../ubnt/configure-host/ansible-playbook.config.yml
  hosts: ubnt
  tasks: 

    - name: load dhcp_csv
      community.general.read_csv:
        path: "{{ configure.dhcp.dhcp_csv }}"
      register: dhcp_csv
      delegate_to: localhost
      connection: local

    - name: delete host
      community.network.edgeos_config:
        lines:
          - delete system static-host-mapping host-name
      register: delete_result
      until: "delete_result is not failed"
      retries: 2
      delay: 1

    - name: configure host by dhcp_csv
      when: 
        - item.cl_name != ''
        - item.location in location[location.at]
      community.network.edgeos_config:
        lines:
          - delete system static-host-mapping host-name {{ item.cl_name }}
          - set system static-host-mapping host-name {{ item.cl_name }} inet {{ item.ip_addr }}
      loop: "{{ dhcp_csv.list }}"

    - name: load domain_csv
      community.general.read_csv:
        path: "{{ configure.dns.domain_csv }}"
      register: domain_csv
      delegate_to: localhost
      connection: local

    - name: configure host by domain_csv
      when: 
        - item.cl_name != ''
        - item.where in location[location.at]
      community.network.edgeos_config:
        lines:
          - delete system static-host-mapping host-name {{ item.cl_name }}
          - set system static-host-mapping host-name {{ item.cl_name }} inet {{ item.ip_addr }}
          - delete system static-host-mapping host-name {{ item.cl_name }}{{ item.ubnt_domain }}
          - set system static-host-mapping host-name {{ item.cl_name }}{{ item.ubnt_domain }} inet {{ item.ip_addr }}
      loop: "{{ domain_csv.list }}"