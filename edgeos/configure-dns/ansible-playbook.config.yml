---


- name: config
  vars:
    run_wsl: |
      ansible-playbook \
        --inventory $PWD/ansible-inventories \
        $PWD/../../../edgeos/configure-dns/ansible-playbook.config.yml
  hosts: edgeos
  tasks:

    - name: delete dns forwarding options
      community.network.edgeos_config:
        lines:
          - delete service dns forwarding options
      register: delete_result
      until: "delete_result is not failed"
      retries: 3
      delay: 1

    - name: load domain_csv
      delegate_to: localhost
      connection: local
      when: configure.dns.domain_csv is defined
      community.general.read_csv:
        path: "{{ configure.dns.domain_csv }}"
      register: domain_csv

    - name: set dns forwarding options by domain_csv
      loop: "{{ domain_csv.list | default([],true) }}"
      when:
        - item.cl_name != ''
        - item.where in location[location.at]
      community.network.edgeos_config:
        lines:
          - set service dns forwarding options address=/.{{ item.cl_name }}/{{ item.ip_addr }}

    - name: set dns forwarding options by filter_aaaa
      loop: "{{ configure.dns.filter_aaaa | default([],true) }}"
      community.network.edgeos_config:
        lines:
          - "set service dns forwarding options server=/{{ item }}/#"
          - "set service dns forwarding options address=/{{ item }}/::"
