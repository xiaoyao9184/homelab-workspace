---


- name: config
  vars:
    run_wsl: |
      ansible-playbook \
        --inventory $PWD/ansible-inventories \
        $PWD/../../../edgeos/configure-dns/ansible-playbook.config.yml
  hosts: edgeos
  tasks:

    - name: load domain_csv
      community.general.read_csv:
        path: "{{ configure.dns.domain_csv }}"
      register: domain_csv
      delegate_to: localhost
      connection: local

    - name: delete dns
      community.network.edgeos_config:
        lines:
          - delete service dns forwarding options
      register: delete_result
      until: "delete_result is not failed"
      retries: 3
      delay: 1

    - name: configure dns by domain_csv
      when:
        - item.cl_name != ''
        - item.where in location[location.at]
      community.network.edgeos_config:
        lines:
          - set service dns forwarding options address=/.{{ item.cl_name }}/{{ item.ip_addr }}
      loop: "{{ domain_csv.list }}"