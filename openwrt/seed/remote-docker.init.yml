---

- name: init
  vars:
    run_wsl: |
      ansible-playbook \
        --inventory $PWD/ansible \
        $PWD/../../../openwrt/seed/remote-docker.init.yml
  hosts: openwrt
  roles:
    - gekmihesg.openwrt
  tasks: 

    - name: opkg dockerd
      opkg:
        update_cache: true
        name: dockerd
      ignore_errors: yes

    - name: opkg luci-app-dockerman
      opkg:
        update_cache: true
        name: luci-app-dockerman
      ignore_errors: yes

    - name: opkg sudo
      opkg:
        update_cache: true
        name: sudo
      ignore_errors: yes

    - name: opkg python3-pip
      opkg:
        update_cache: true
        name: python3-pip
      ignore_errors: yes

    - name: set pip sources
      when: pip.mirror is defined
      ansible.builtin.shell: pip3 config set global.index-url {{ pip.mirror }}

    - name: update pip
      ansible.builtin.shell: python -m pip install -U pip
      register: pip_result
      until: "pip_result is not failed"
      retries: 3
      delay: 5

    - name: install the package for Community.Docker
      ansible.builtin.pip:
        name: "{{ item }}"
        state: latest
      loop: 
          - docker
          - docker-compose
          - jsondiff
          # - pyyaml
          - lxml
          - psycopg2-binary
          - jmespath
      register: pip_result
      until: "pip_result is not failed"
      retries: 3
      delay: 5

    - name: install the package for docker-seed-ansible
      ansible.builtin.pip:
        name: 
          - requests
        state: latest
      register: pip_result
      until: "pip_result is not failed"
      retries: 3
      delay: 5
