---

- name: set run_pgsql
  ansible.builtin.set_fact:
    run_pgsql:
      name: "run-pgsql.{{ run_name }}"
      file: "{{ run_file }}"
      host: "{{ postgres_host }}"
      port: "{{ postgres_port }}"
      database: "{{ postgres_database }}"
      user: "{{ postgres_user }}"
      password: "{{ postgres_password }}"

- name: run sql file to pgsql
  community.docker.docker_container:
    name: "{{ run_pgsql.name }}"
    state: started
    image: crunchydata/crunchy-postgres:centos8-13.3-4.6.3
    env:
      MODE: sqlrunner
      PG_HOST: "{{ run_pgsql.host }}"
      PG_PORT: "{{ run_pgsql.port }}"
      PG_DATABASE: "{{ run_pgsql.database }}"
      PG_USER: "{{ run_pgsql.user }}"
      PG_PASSWORD: "{{ run_pgsql.password }}"
    mounts:
      - source: "{{ run_pgsql.file }}"
        target: "/pgconf/clear.sql"
        type: "bind"
    networks: "{{ run_network | map('community.general.dict_kv', 'name') }}"
    labels:
      "com.docker.stack.namespace": seed
      "com.github.xiaoyao9184.docker-seed.type": "pgsql-sql.run"
      "com.github.xiaoyao9184.docker-seed.creator": "{{ lookup('ansible.builtin.env', 'SEED_NAME', default='pgsql-sql.run') }}"
  register: result_run_pgsql
  until: "result_run_pgsql is not failed"
  retries: 1000
  delay: 10
          