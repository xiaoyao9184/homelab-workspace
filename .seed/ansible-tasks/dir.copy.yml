---


- name: dir.copy|set _dir_copy
  ansible.builtin.set_fact:
    _dir_copy: "{{ dir_copy }}"

- name: dir.copy|mkdir dest parent
  delegate_to: "{{ _dir_copy.delegate_to | default(omit) }}"
  run_once: "{{ _dir_copy.run_once | default(false) }}"
  ansible.builtin.file:
    path: "{{ _dir_copy.dest | dirname }}"
    state: directory

# mean no src copy is just mkdir
- name: dir.copy|mkdir dest
  delegate_to: "{{ _dir_copy.delegate_to | default(omit) }}"
  run_once: "{{ _dir_copy.run_once | default(false) }}"
  when:
    - _dir_copy.src is undefined
  ansible.builtin.file:
    path: "{{ _dir_copy.dest }}"
    mode: "{{ _dir_copy.mode | default(omit) }}"
    state: directory

- name: dir.copy|copy
  delegate_to: "{{ _dir_copy.delegate_to | default(omit) }}"
  run_once: "{{ _dir_copy.run_once | default(false) }}"
  vars:
    remote_keys: ['group','run_once','delegate_to']
    copy_keys: "{{ _dir_copy.keys() | difference(remote_keys) }}"
    copy_values: "{{ copy_keys | map('extract', _dir_copy) | list }}"
    copy_item: "{{ dict(copy_keys | zip(copy_values)) }}"
  when:
    - _dir_copy.src is defined
    - _dir_copy.dest is defined
  ansible.builtin.copy: "{{ copy_item }}"

- name: dir.copy|reset _dir_copy
  ansible.builtin.set_fact:
    _dir_copy: !!null
