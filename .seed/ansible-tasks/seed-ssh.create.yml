---

- name: seed-ssh.create|check ssh_user
  when:
    - ssh_user | default(None) == ''
  ansible.builtin.pause:
    prompt: "What is ssh user?"
    echo: true
  register: prompt_ssh_user

- name: seed-ssh.create|check ssh_group
  when:
    - ssh_group | default(None) == ''
  ansible.builtin.pause:
    prompt: "What is ssh group(also an dir name of ssh key)?"
    echo: true
  register: prompt_ssh_group

- name: seed-ssh.create|set _ssh
  ansible.builtin.set_fact:
    _ssh:
      username: "{{ ssh_user | default(prompt_ssh_user.user_input) }}"
      basename: "{{ ssh_group | default(prompt_ssh_group.user_input) }}"
      ansible_group: "{{ ansible_group | default('ssh',true) }}"
      keyscan_type: "{{ keyscan_type | default('ed25519',true) }}"

# - name: seed-ssh.create|register variable to SEED host
#   ansible.builtin.add_host:
#     name: "SEED"
#     username: "{{ _ssh.username }}"
#     basename: "{{ _ssh.basename }}"

- name: seed-ssh.create|create a directory for ssh
  ansible.builtin.file:
    path: "~/.ssh/{{ _ssh.basename }}/"
    state: directory

- name: seed-ssh.create|generate an OpenSSH keypair rsa 2048
  community.crypto.openssh_keypair:
    path: "~/.ssh/{{ _ssh.basename }}/id_rsa"
    size: 2048
    type: rsa
    comment: "{{ _ssh.basename }}"
  # https://github.com/microsoft/WSL/issues/670
  register: generate_result
  until: "generate_result is not failed"
  retries: 3
  delay: 1

- name: seed-ssh.create|add a host in the configuration
  loop: "{{ groups[_ssh.ansible_group] }}"
  loop_control:
    loop_var: name
  vars:
    host: "{{ hostvars[name].ansible_host | default(name,true) }}"
  community.general.ssh_config:
    ssh_config_file: "~/.ssh/config"
    host: "{{ host }}"
    hostname: "{{ host }}"
    remote_user: "{{ _ssh.username }}"
    identity_file: "~/.ssh/{{ _ssh.basename }}/id_rsa"
    # user_known_hosts_file: "~/.ssh/known_hosts"
    state: present

- name: seed-ssh.create|set _known_host_list
  ansible.builtin.set_fact:
    _known_host_list: []

# - name: seed-ssh.create|add item known_name to _known_host_list
#   loop: "{{ groups[_ssh.ansible_group] }}"
#   loop_control:
#     loop_var: name
#   vars:
#     host_only: "{{ hostvars[name].ansible_host | default(name,true) }}"
#     host_port: "[{{ host_only }}]:{{ hostvars[name].ansible_port }}"
#     known_item:
#       host_name: "{{ name }}"
#       known_name: "{{ host_port if (hostvars[name].ansible_port is defined) else host_only }}"
#   ansible.builtin.set_fact:
#     _known_host_list: "{{ _known_host_list + [known_item] }}"

- name: seed-ssh.create|get ssh ecdsa fingerprint for host
  loop: "{{ groups[_ssh.ansible_group] }}"
  loop_control:
    loop_var: name
  vars:
    host: "{{ hostvars[name].ansible_host | default(name,true) }}"
    port: "{{ hostvars[name].ansible_port | default(22,true) }}"
  ansible.builtin.command: ssh-keyscan -t {{ _ssh.keyscan_type }} -p {{ port }} {{ host }} | grep -v ^#
  register: keyscan_key_list
  ignore_errors: yes

- name: seed-ssh.create|append _known_host_list
  loop: "{{ keyscan_key_list.results }}"
  loop_control:
    loop_var: keyscan_key_item
  when: keyscan_key_list is not failed
  vars:
    name: "{{ keyscan_key_item.name }}"
    host_only: "{{ hostvars[name].ansible_host | default(name,true) }}"
    host_port: "[{{ host_only }}]:{{ hostvars[name].ansible_port }}"
    known_item:
      host_name: "{{ name }}"
      known_name: "{{ host_port if (hostvars[name].ansible_port is defined) else host_only }}"
      known_key: "{{ keyscan_key_item.stdout }}"
  ansible.builtin.set_fact:
    _known_host_list: "{{ _known_host_list + [known_item] }}"

- name: seed-ssh.create|set ssh ecdsa fingerprint to known_hosts
  loop: "{{ _known_host_list }}"
  loop_control:
    loop_var: known_host_item
  when: keyscan_key_list is not failed
  ansible.builtin.known_hosts:
    path: ~/.ssh/known_hosts
    name: "{{ known_host_item.known_name }}"
    key: "{{ known_host_item.known_key }}"
  ignore_errors: yes

- name: seed-ssh.create|print info
  debug:
    msg:
      - "user: {{ lookup('env', 'USER') }}"
      - "path: ~/.ssh/{{ _ssh.basename }}/"
      - "config: ~/.ssh/config"

- name: seed-ssh.create|reset _ssh
  ansible.builtin.set_fact:
    _ssh: !!null