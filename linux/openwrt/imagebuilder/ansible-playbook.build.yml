---

- name: build
  vars:
    run_wsl: |
      ansible-playbook \
        --ask-become-pass \
        --inventory $PWD/ansible \
        $PWD/../../../linux/openwrt/imagebuilder/ansible-playbook.build.yml
    OPENWRT_RELEASE: "{{ openwrt.imagebuilder.OPENWRT_RELEASE }}"
    OPENWRT_TARGET: "{{ openwrt.imagebuilder.OPENWRT_TARGET }}"
  hosts: localhost
  connection: local
  tasks: 

    - name: install build package 
      become: true
      ansible.builtin.package:
        name: 
          - build-essential
          - libncurses5-dev
          - libncursesw5-dev
          - zlib1g-dev
          - gawk
          - git
          - gettext
          - libssl-dev
          - xsltproc
          - rsync
          - wget
          - unzip
          - python
        state: present
      register: package_result
      until: "package_result is not failed"
      retries: 3
      delay: 5

    - name: mkdir builder path
      ansible.builtin.file:
        path: "~/.openwrt"
        state: directory

    - name: set builder_dir by snapshots
      when: openwrt.imagebuilder.OPENWRT_RELEASE == 'snapshots'
      ansible.builtin.set_fact:
        builder_url: "https://downloads.openwrt.org/snapshots/targets/{{ OPENWRT_TARGET | regex_replace('-', '/') }}/openwrt-imagebuilder-{{ OPENWRT_TARGET }}.Linux-x86_64.tar.xz"
        builder_dir: "~/.openwrt/openwrt-imagebuilder-{{ OPENWRT_TARGET }}.Linux-x86_64"

    - name: set builder_dir by releases
      when: openwrt.imagebuilder.OPENWRT_RELEASE != 'snapshots'
      ansible.builtin.set_fact:
        builder_url: "https://downloads.openwrt.org/releases/{{ OPENWRT_RELEASE }}/targets/{{ OPENWRT_TARGET | regex_replace('-', '/') }}/openwrt-imagebuilder-{{ OPENWRT_RELEASE }}-{{ OPENWRT_TARGET }}.Linux-x86_64.tar.xz"
        builder_dir: "~/.openwrt/openwrt-imagebuilder-{{ OPENWRT_RELEASE }}-{{ OPENWRT_TARGET }}.Linux-x86_64"

    - name: check builder file
      ansible.builtin.stat:
        path: "{{ builder_dir }}.tar.xz"
      register: builder_stat

    - name: download builder file
      when: not builder_stat.stat.exists 
      ansible.builtin.get_url:
        url: "{{ builder_url }}"
        dest: "{{ builder_dir }}.tar.xz"

    - name: unarchive builder file
      ansible.builtin.unarchive:
        src: "{{ builder_dir }}.tar.xz"
        dest: "~/.openwrt"

    - name: get builder info
      ansible.builtin.shell:
        cmd: make info
        chdir: "{{ builder_dir }}"
      register: builder_info

    - name: print builder info
      ansible.builtin.pause:
        seconds: 1
        prompt: |
          //////////////////////////////////////////////////

          {{ builder_info.stdout }}
          //////////////////////////////////////////////////

    - name: set builder_file
      when: openwrt.imagebuilder.BUILDER_FILE is defined
      ansible.builtin.set_fact:
        builder_file: "FILES={{ openwrt.imagebuilder.BUILDER_FILE }}"
        
    - name: run builder make
      ansible.builtin.shell:
        cmd: "make image PROFILE={{ profile }} PACKAGES=\"{{ packages }}\" {{ file }}"
        chdir: "{{ builder_dir }}"
      register: builder_info
      vars:
        profile: "{{ openwrt.imagebuilder.BUILDER_PROFILE }}"
        packages: "{{ openwrt.imagebuilder.BUILDER_PACKAGES | join(' ') }}"
        file: "{{ builder_file | default('') }}"
