---

- name: test
  vars:
    run_debug: |
      ansible-playbook \
        -vvv \
        --inventory $PWD/ansible-inventories \
        $PWD/../../../test/seed/docker-volume.push/ansible-playbook.test.yml
    run_normal: |
      ansible-playbook \
        --inventory $PWD/ansible-inventories \
        $PWD/../../../test/seed/docker-volume.push/ansible-playbook.test.yml
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ env_path | default('') }}"
  hosts: docker
  run_once: true
  tasks:

    - name: mkdir build path
      run_once: true
      delegate_to: localhost
      ansible.builtin.file:
        path: "{{ playbook_dir }}/build/vol"
        state: directory

    - name: remove container
      community.docker.docker_container:
        name: test-volume-push
        state: absent

    - name: remove volume
      community.docker.docker_volume:
        name: test-volume-push
        state: absent

    - name: wait volume not exists
      include_tasks: "{{ playbook_dir }}/../../../.seed/ansible-tasks/docker-volume.wait.yml"
      vars:
        volumes:
          test-volume-push:
            retries: 1
            delay: 10
            until:
              - not volume_loop_info.exists

    - name: add volume
      community.docker.docker_volume:
        name: test-volume-push
        driver: local
        driver_options:
          type: none
          device: "{{ playbook_dir }}/build/vol"
          o: bind

    - name: push volume
      include_tasks: "{{ playbook_dir }}/../../../.seed/ansible-tasks/docker-volumes.push.yml"
      vars:
        volumes:
          test-volume-push:
            src: "{{ playbook_dir }}/ansible-playbook.test.yml"
            dest: "./ansible-playbook.test.yml"
            directory_mode: '0777'

    - name: remove volume
      community.docker.docker_volume:
        name: test-volume-push
        state: absent

    - name: add volume
      community.docker.docker_volume:
        name: test-volume-push

    - name: create temporary file remote src
      ansible.builtin.tempfile:
        state: file
        suffix: seed
      register: remote_temporary_file

    - name: create temporary directory remote src
      ansible.builtin.tempfile:
        state: directory
        suffix: seed
      register: remote_temporary_directory

    - name: push volume
      include_tasks: "{{ playbook_dir }}/../../../.seed/ansible-tasks/docker-volumes.push.yml"
      vars:
        volumes:
          - name: test-volume-push
            src: "{{ playbook_dir }}/ansible-playbook.test.yml"
            dest: "ansible-playbook.test.yml"
            directory_mode: '0777'
          - name: test-volume-push
            src: "{{ playbook_dir }}/build"
            dest: ""
            directory_mode: '0777'
          - name: test-volume-push
            remote_src: true
            src: "{{ remote_temporary_file.path }}"
            dest: "from_remote_file"
            directory_mode: '0777'
          - name: test-volume-push
            remote_src: true
            src: "{{ remote_temporary_directory.path }}"
            dest: "from_remote_directory"
            directory_mode: '0777'

    - name: remove temporary file remote src
      ansible.builtin.file:
        path: "{{ remote_temporary_file.path }}"
        state: absent

    - name: remove temporary directory remote src
      ansible.builtin.file:
        path: "{{ remote_temporary_directory.path }}"
        state: absent

    - name: remove container
      community.docker.docker_container:
        name: test-volume-push
        state: absent

    - name: remove volume
      community.docker.docker_volume:
        name: test-volume-push
        state: absent
