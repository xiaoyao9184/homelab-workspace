version: "3.8"

networks:
  telegraf:
    name: telegraf_default
{# {% for key, value in VARS.NETWORKS.items() %}
  {{ key }}:
    name: {{ value.name }}
{% if value.external is defined %}
    external: {{ value.external | lower }}
{% endif %}
{% endfor %} #}

services:
  telegraf:
    image: telegraf:1.24.1
    hostname: "{{ VARS.HOMENAME }}"
    user: telegraf:{{ VARS.USR_GROUP }}
    env_file: external_env-all.env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/share/snmp/mibs/:/usr/share/snmp/mibs/
      - /var/lib/mibs:/var/lib/mibs
      - {{ VARS.BIND_CONF }}:/etc/telegraf/telegraf.conf
    networks:
      - telegraf
{% for name in VARS.NETWORKS.keys() %}
      - {{ name }}
{% endfor %}
    container_name: telegraf
    restart: always
    healthcheck:
      test: curl -f http://localhost:8080 || exit 1
      interval: 60s
      timeout: 5s
      retries: 10
      start_period: 10m