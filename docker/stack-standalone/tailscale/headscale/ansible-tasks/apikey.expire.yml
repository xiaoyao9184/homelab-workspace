---

- name: headscale set apikey
  ansible.builtin.set_fact:
    apikey:
      container_id: "{{ _apikey.container_id }}"

- when: _apikey.prefix is undefined
  block:
    - name: headscale list apikey
      community.docker.docker_container_exec:
        container: "{{ apikey.container_id }}"
        command: "headscale apikey list -o json"
      register: apikey_result

    - name: headscale set apikey.prefix
      ansible.builtin.set_fact:
        apikey: "{{ apikey | combine(update, recursive=True) }}"
      vars:
        update:
          prefix: "{{ apikey_result.stdout | from_json | json_query('[].prefix') | default([], true) }}"

- name: headscale expire apikey
  community.docker.docker_container_exec:
    container: "{{ apikey.container_id }}"
    command: "headscale apikey expire --prefix {{ item }}"
  loop: "{{ apikey.prefix }}"
  register: apikey_result

- name: headscale set apikey.result
  ansible.builtin.set_fact:
    apikey: "{{ apikey | combine(update, recursive=True) }}"
  vars:
    update:
      result: "{{ apikey_result | json_query('results[].{item: item,result: stdout}') }}"

- name: headscale print apikey
  debug:
    var: apikey

- name: headscale reset apikey_result
  ansible.builtin.set_fact:
    apikey_result: !!null