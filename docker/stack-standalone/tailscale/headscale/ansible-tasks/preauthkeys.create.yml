---


- name: headscale set preauthkeys
  ansible.builtin.set_fact:
    preauthkeys:
      namespace: "{{ _preauthkeys.namespace | default('default') }}"
      expire: "{{ _preauthkeys.expire | default('240h') }}" 
      container_id: "{{ _preauthkeys.container_id }}"

- name: headscale create preauthkeys
  community.docker.docker_container_exec:
    container: "{{ preauthkeys.container_id }}"
    command: "headscale preauthkeys create -e {{ preauthkeys.expire }} -n {{ preauthkeys.namespace }} --reusable"
  register: preauthkeys_result

- name: headscale set preauthkeys.result
  ansible.builtin.set_fact:
    preauthkeys: "{{ preauthkeys | combine(update, recursive=True) }}"
  vars:
    update:
      result: "{{ preauthkeys_result.stdout }}"

- name: headscale print preauthkeys
  debug:
    var: preauthkeys

- name: headscale reset preauthkeys_result
  ansible.builtin.set_fact:
    preauthkeys_result: !!null