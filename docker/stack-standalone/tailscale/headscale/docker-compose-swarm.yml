version: "3.7"

configs:
  stack_cfg-config.yaml:
    file: ./config/config.yaml

volumes:
  stack_vol-config:
  stack_vol-data:

networks:
  external_net-headscale:
    external: true

services:
  headscale:
    image: headscale/headscale:latest-alpine
    command: headscale serve
    cap_add:
      - CAP_NET_BIND_SERVICE
    configs:
      - source: stack_cfg-config.yaml
        target: /etc/headscale/config.yaml
    volumes:
      - stack_vol-config:/etc/headscale/
      - stack_vol-data:/var/lib/headscale
    ports:
      - 8080:8080
    networks:
      - external_net-headscale
    deploy:
      replicas: 1
      placement:
        constraints: 
          - node.platform.os == linux
      update_config:
        parallelism: 2
        delay: 10s
      restart_policy:
        condition: on-failure
